class TweetsController < ApplicationController

    def index
        @user = User.find(params[:user_id])
        @tweets = @user.tweets 
    end

    def show
        @user = User.find(params[:user_id])
        @person_tweet = @user.tweets.find(params[:id]) 
    end

    def new
        @tweet = Tweet.new
    end

    def create
        @tweet = current_user.tweets.build(tweet_params)
        if @tweet.save!
          redirect_to :action => "top"
        else
          redirect_to :action => "new"
        end
    end

    def top
        @tweet = Tweet.find(params[:id]) if params[:id]
    end

    def destroy
        tweet = Tweet.find(params[:user_id])
        tweet.destroy
        flash[:notice] = 'シフト希望を取り消しました。'
        redirect_to :root #削除に成功すればrootページに戻る
    end

    def export_to_google_sheets
      # Google Drive APIのスコープを定義
      scopes = ["https://www.googleapis.com/auth/spreadsheets"]
    
      # Google Drive APIを使ってスプレッドシートにアクセス
      session = GoogleDrive::Session.from_config("config/credentials.json", scope: scopes)
    
      # Googleスプレッドシートを開く
      spreadsheet = session.spreadsheet_by_title("シフト表")
      worksheet = spreadsheet.worksheets[0]
    
      # 現在のユーザーIDを取得
      current_user_id = params[:user_id]
      current_user = User.find_by(id: current_user_id)
    
      if current_user.nil?
        logger.error "User not found with ID: #{current_user_id}"
        redirect_to top_user_tweets_path, notice: "ユーザーが見つかりませんでした"
        return
      end
    
      # 現在のユーザーのツイートを取得
      logger.debug "Fetching tweets for user: #{current_user.name}"
      tweets = Tweet.where(user_id: current_user.id)
      logger.debug "Fetched tweets: #{tweets.inspect}"
    
      # スプレッドシート内の各行を処理
      (1..worksheet.num_rows).each do |row|
        # スプレッドシートの2列目には名前が入っていると仮定
        sheet_name = worksheet[row, 2]
    
        # スプレッドシートの名前と一致するユーザーを探す
        matching_user = User.find_by(name: sheet_name)
    
        # 一致するユーザーが見つかれば、そのユーザーのツイートを探す
        if matching_user && matching_user.id == current_user.id
          matching_tweet = tweets.find { |tweet| tweet.user_id == matching_user.id }
    
          # 一致するツイートがあれば、その日の時間を記入
          if matching_tweet
            case matching_tweet.day_of_week
            when "Monday"
              worksheet[row, 3] = matching_tweet.time
            when "Tuesday"
              worksheet[row, 4] = matching_tweet.time
            when "Wednesday"
              worksheet[row, 5] = matching_tweet.time
            when "Thursday"
              worksheet[row, 6] = matching_tweet.time
            when "Friday"
              worksheet[row, 7] = matching_tweet.time
            when "Saturday"
              worksheet[row, 8] = matching_tweet.time
            when "Sunday"
              worksheet[row, 9] = matching_tweet.time
            end
          end
        end
      end
    
      begin
        if worksheet.save
          redirect_to top_user_tweets_path, notice: "Googleスプレッドシートにエクスポートが完了しました"
        else
          Rails.logger.error "Worksheet save failed"
          redirect_to top_user_tweets_path, notice: "エクスポートに失敗しました"
        end
      rescue => e
        Rails.logger.error "Error during worksheet save: #{e.message}"
        redirect_to top_user_tweets_path, notice: "エクスポート中にエラーが発生しました: #{e.message}"
      end
    end
    
    
    
    private

    def tweet_params
        params.require(:tweet).permit(:date, :user_id, :day_of_week, :time)
    end
end
